"use strict";(self.webpackChunkdocs_template=self.webpackChunkdocs_template||[]).push([[145],{4826:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>d,contentTitle:()=>n,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>l});var r=s(5893),i=s(1151);const o={sidebar_position:1},n="Build an Adapter",a={id:"defi-adapters/how-to/build-an-adapter",title:"Build an Adapter",description:"This will guide you through the steps to build an adapter for your DeFi protocol.",source:"@site/docs/defi-adapters/how-to/build-an-adapter.md",sourceDirName:"defi-adapters/how-to",slug:"/defi-adapters/how-to/build-an-adapter",permalink:"/metamask-institutional.docs/defi-adapters/how-to/build-an-adapter",draft:!1,unlisted:!1,tags:[],version:"current",lastUpdatedBy:"Xavier Brochard",lastUpdatedAt:1728028938e3,sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"defiAdaptersSidebar",previous:{title:"How to",permalink:"/metamask-institutional.docs/category/how-to"}},d={},l=[{value:"1. Set up",id:"1-set-up",level:2},{value:"2. Run the CLI",id:"2-run-the-cli",level:2},{value:"3. Inspect your new adapter",id:"3-inspect-your-new-adapter",level:2},{value:"4. Build Smart Contract Classes from ABIs",id:"4-build-smart-contract-classes-from-abis",level:2},{value:"5. Build your DeFi asset metadata files",id:"5-build-your-defi-asset-metadata-files",level:2},{value:"6. Use the dev UI to validate position and profit responses",id:"6-use-the-dev-ui-to-validate-position-and-profit-responses",level:2},{value:"7. Create snapshot tests",id:"7-create-snapshot-tests",level:2},{value:"Positions",id:"positions",level:3},{value:"Profits",id:"profits",level:3},{value:"Deposits/Withdrawals/Repays/Borrows",id:"depositswithdrawalsrepaysborrows",level:3},{value:"TVL",id:"tvl",level:3},{value:"8. Pull Request",id:"8-pull-request",level:2}];function c(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"build-an-adapter",children:"Build an Adapter"})}),"\n",(0,r.jsx)(t.p,{children:"This will guide you through the steps to build an adapter for your DeFi protocol."}),"\n",(0,r.jsx)(t.h2,{id:"1-set-up",children:"1. Set up"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"git clone https://github.com/consensys-vertical-apps/mmi-defi-adapters.git\ncd mmi-defi-adapters\nnvm use\nnpm i\n"})}),"\n",(0,r.jsx)(t.p,{children:"Then, in a separate terminal:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"nvm use\nnpm run dev\n"})}),"\n",(0,r.jsx)("div",{class:"google-drive-video-wrapper",children:(0,r.jsx)("iframe",{src:"https://drive.google.com/file/d/1bp9Y8uxQDYxgIyMTk5945vLOwCG1JOn3/preview",title:"Set up",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:!0})}),"\n",(0,r.jsx)(t.h2,{id:"2-run-the-cli",children:"2. Run the CLI"}),"\n",(0,r.jsx)(t.p,{children:"Start a new adapter by running this command:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"npm run new-adapter\n"})}),"\n",(0,r.jsx)(t.p,{children:"You'll be asked a series of questions to describe your DeFi product, such as:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["Is the ",(0,r.jsx)(t.code,{children:"balanceOf(address)"})," function used to query the asset balance in your product?"]}),"\n",(0,r.jsx)(t.li,{children:"How many underlying tokens does your DeFi asset represent?"}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"These questions help the library generate the necessary code, reducing the amount of custom code you need to write."}),"\n",(0,r.jsxs)(t.admonition,{type:"info",children:[(0,r.jsx)(t.p,{children:"The first question gives you an overview of all the prompts:"}),(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"CLI First Question",src:s(6586).Z+"",width:"895",height:"411"})})]}),"\n",(0,r.jsx)(t.p,{children:"To dive deeper in the prompts, watch the video below:"}),"\n",(0,r.jsx)("div",{class:"google-drive-video-wrapper",children:(0,r.jsx)("iframe",{src:"https://drive.google.com/file/d/1Pl0yB2d1s-3oKFCXAyRhKx7rK2x43Qtf/preview",title:"Run the CLI",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:!0})}),"\n",(0,r.jsx)(t.h2,{id:"3-inspect-your-new-adapter",children:"3. Inspect your new adapter"}),"\n",(0,r.jsxs)(t.p,{children:["After completing all the prompts, the CLI will generate the code files for your new adapter in ",(0,r.jsx)(t.code,{children:"/packages/adapters-library/src/adapters/<protocol-id>/products/<product-id>/xxxxAdapter.ts"}),"."]}),"\n",(0,r.jsx)(t.p,{children:"The video below walks you through the contents of the generated files and explains any modifications you'll need to make."}),"\n",(0,r.jsx)("div",{class:"google-drive-video-wrapper",children:(0,r.jsx)("iframe",{src:"https://drive.google.com/file/d/1wLTd8utKB3vXHd-Vr2Cv1ElpLYHpPXCX/preview",title:"Inspect your new adapter",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:!0})}),"\n",(0,r.jsx)(t.h2,{id:"4-build-smart-contract-classes-from-abis",children:"4. Build Smart Contract Classes from ABIs"}),"\n",(0,r.jsx)(t.p,{children:"If your adapter requires implementations that rely on on-chain queries to your protocol's smart contracts, you'll need to import ABIs to create factories for type-safe interaction with those contracts."}),"\n",(0,r.jsxs)(t.p,{children:["To do this, add a JSON file containing the ABI for each contract to the contracts/abis folder of your protocol (e.g., ",(0,r.jsx)(t.code,{children:"/packages/adapters-library/src/adapters/<protocol-id>/abis"}),"). Afterward, run the following command to generate the contract factories, which you can then import into your adapter."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"npm run build-types\n"})}),"\n",(0,r.jsx)(t.p,{children:"This video walks you through the process."}),"\n",(0,r.jsx)("div",{class:"google-drive-video-wrapper",children:(0,r.jsx)("iframe",{src:"https://drive.google.com/file/d/1abo6lKGGTnNMKgvfiDPotFWUvey8UqZI/preview",title:"Build Smart Contract Classes from ABIs",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:!0})}),"\n",(0,r.jsx)(t.h2,{id:"5-build-your-defi-asset-metadata-files",children:"5. Build your DeFi asset metadata files"}),"\n",(0,r.jsx)(t.p,{children:"Upon inspecting the adapter start by filling details for the following methods"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"getProtocolDetails"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"buildMetadata"})}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["After implementing ",(0,r.jsx)(t.code,{children:"buildMetadata"}),", create the JSON metadata files that will be used at runtime by running"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"npm run build-metadata -- -p <protocol-id>\n"})}),"\n",(0,r.jsx)(t.p,{children:"Then check if the following methods need to be implemented or code has already been added based on the CLI questions:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"getProtocolTokens"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"getPositions"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"unwrap"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"getWithdrawals"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"getDeposits"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"getTotalValueLocked"})}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"Finally, if any reward method has been added, the implementation will have to be provided for it to work:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"getRewardPositions"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"getRewardWithdrawals"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"getExtraRewardPositions"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"getExtraRewardWithdrawals"})}),"\n"]}),"\n",(0,r.jsx)("div",{class:"google-drive-video-wrapper",children:(0,r.jsx)("iframe",{src:"https://drive.google.com/file/d/1F6AnSkhd9Iu7f62f3VcAJ60iHZfAib1B/preview",title:"Build your DeFi asset metadata files",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:!0})}),"\n",(0,r.jsx)(t.h2,{id:"6-use-the-dev-ui-to-validate-position-and-profit-responses",children:"6. Use the dev UI to validate position and profit responses"}),"\n",(0,r.jsxs)(t.p,{children:["The command ",(0,r.jsx)(t.code,{children:"npm run dev"})," that you've launched at ",(0,r.jsx)(t.a,{href:"#1-set-up",children:"step 1"})," also runs a dev UI at ",(0,r.jsx)(t.a,{href:"http://localhost:5173/",children:"http://localhost:5173/"}),". This allows you to visually check user positions and view the raw JSON data for debugging. Simply enter an Ethereum address and filter by the protocol you're working on to see the relevant data."]}),"\n",(0,r.jsx)(t.h2,{id:"7-create-snapshot-tests",children:"7. Create snapshot tests"}),"\n",(0,r.jsxs)(t.p,{children:["The final step is to create tests to validate the adapter's results and ensure future changes don't cause issues. Within your protocol's folder, you'll find a tests directory and a file ",(0,r.jsx)(t.code,{children:"/packages/adapters-library/src/adapters/<protocol-id>/tests/testCases.ts"})," that exports an array of test cases."]}),"\n",(0,r.jsxs)(t.p,{children:["For each test case, you must specify the ",(0,r.jsx)(t.code,{children:"chain"})," and ",(0,r.jsx)(t.code,{children:"method"}),". Optionally, you can include a ",(0,r.jsx)(t.code,{children:"key"})," to identify the test case, but this is only necessary if you're writing multiple tests for the same ",(0,r.jsx)(t.code,{children:"method"})," and ",(0,r.jsx)(t.code,{children:"chain"}),". For more details, refer to the following sub-sections."]}),"\n",(0,r.jsxs)(t.p,{children:["After completing your ",(0,r.jsx)(t.code,{children:"testCases.ts"})," file, run the following command to generate the snapshots for those tests."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"npm run build-snapshots -- -p <protocol-id>\n"})}),"\n",(0,r.jsx)(t.p,{children:"You can then verify the validity of those snapshots by running:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"npm run test:integration --protocol=protocol-id\n"})}),"\n",(0,r.jsx)("div",{class:"google-drive-video-wrapper",children:(0,r.jsx)("iframe",{src:"https://drive.google.com/file/d/1pVWcssMHTQBH-m_BjVTwpRKamIY6UUK9/preview",title:"Build your DeFi asset metadata files",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:!0})}),"\n",(0,r.jsx)(t.h3,{id:"positions",children:"Positions"}),"\n",(0,r.jsxs)(t.p,{children:["To get a snapshot of the positions, you need to set ",(0,r.jsx)(t.code,{children:"method: 'positions'"})," and provide an input field with the ",(0,r.jsx)(t.code,{children:"userAddress"}),". Optionally, you can specify a ",(0,r.jsx)(t.code,{children:"blockNumber"}),", but this is not required, and the latest will be used and recorded if it's left empty. This will run for all the products of this protocol."]}),"\n",(0,r.jsx)(t.p,{children:"For instance:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-js",children:'{\n  chainId: Chain.Ethereum,\n  method: "positions",\n  input: {\n    userAddress: "0x161D61e30284A33Ab1ed227beDcac6014877B3DE",\n  },\n}\n'})}),"\n",(0,r.jsx)(t.h3,{id:"profits",children:"Profits"}),"\n",(0,r.jsxs)(t.p,{children:["To get a snapshot of the profits, you need to set ",(0,r.jsx)(t.code,{children:"method: 'profits'"})," and provide an input field with the userAddress and, optionally, timePeriod, which will default to one day if left empty. Optionally, you can specify a ",(0,r.jsx)(t.code,{children:"blockNumber"}),", but this is not required, and the latest will be used and recorded if it's left empty. This will run for all the products of this protocol."]}),"\n",(0,r.jsx)(t.p,{children:"For instance:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-js",children:'{\n  chainId: Chain.Ethereum,\n  method: "deposits",\n  input: {\n    fromBlock: 198188138,\n    toBlock: 200597430,\n    userAddress: "0xbc0a54c02a1e80c8e25e8173a8a80baf116205b5",\n    protocolTokenAddress: "0x3bAa857646e5A0B475E75a1dbD38E7f0a6742058",\n    productId: "supply",\n  },\n}\n'})}),"\n",(0,r.jsx)(t.h3,{id:"depositswithdrawalsrepaysborrows",children:"Deposits/Withdrawals/Repays/Borrows"}),"\n",(0,r.jsxs)(t.p,{children:["To get a snapshot of any of these methods, set ",(0,r.jsx)(t.code,{children:"method: 'deposits' | 'withdrawals' | 'repays' | 'borrows'"}),". The input field of these methods requires additional parameters to work, including ",(0,r.jsx)(t.code,{children:"userAddress"}),", ",(0,r.jsx)(t.code,{children:"fromBlock"}),", ",(0,r.jsx)(t.code,{children:"toBlock"}),", ",(0,r.jsx)(t.code,{children:"protocolTokenAddress"}),", and ",(0,r.jsx)(t.code,{children:"productId"}),"."]}),"\n",(0,r.jsx)(t.p,{children:"For instance:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-js",children:'{\n  chainId: Chain.Ethereum,\n  method: "deposits",\n  input: {\n    fromBlock: 198188138,\n    toBlock: 200597430,\n    userAddress: "0xbc0a54c02a1e80c8e25e8173a8a80baf116205b5",\n    protocolTokenAddress: "0x3bAa857646e5A0B475E75a1dbD38E7f0a6742058",\n    productId: "supply",\n  },\n}\n'})}),"\n",(0,r.jsx)(t.h3,{id:"tvl",children:"TVL"}),"\n",(0,r.jsxs)(t.p,{children:["To get a snapshot of the TVL implementation, set ",(0,r.jsx)(t.code,{children:"method: 'tvl' and specify the protocol tokens with "}),"filterProtocolToken: ['protocol-token-address1', 'protocol-token-address2']",(0,r.jsx)(t.code,{children:". Optionally, you can specify a "}),"blockNumber`, but this is not required, and the latest will be used and recorded if it's left empty. This will run for all the products of this protocol."]}),"\n",(0,r.jsx)(t.p,{children:"For instance:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-js",children:'{\n  chainId: Chain.Ethereum,\n  method: "tvl",\n  filterProtocolTokens: ["0x3bAa857646e5A0B475E75a1dbD38E7f0a6742058"],\n}\n'})}),"\n",(0,r.jsx)(t.h2,{id:"8-pull-request",children:"8. Pull Request"}),"\n",(0,r.jsx)(t.p,{children:"Once you're satisfied with the work and its results, run the following command to automatically fix any linting errors and receive a report of those requiring manual attention:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"npm run fix\n"})}),"\n",(0,r.jsx)(t.p,{children:"Afterward, create a pull request against the upstream repository. Go through the checklist in the template and ensure all applicable checkboxes are checked."}),"\n",(0,r.jsx)(t.p,{children:"Make sure to allow repository owners permission to make changes to your branch."})]})}function h(e={}){const{wrapper:t}={...(0,i.a)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},6586:(e,t,s)=>{s.d(t,{Z:()=>r});const r=s.p+"assets/images/cli-first-question-4340fba302431721c52758e413fc2edb.png"},1151:(e,t,s)=>{s.d(t,{Z:()=>a,a:()=>n});var r=s(7294);const i={},o=r.createContext(i);function n(e){const t=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:n(e.components),r.createElement(o.Provider,{value:t},e.children)}}}]);